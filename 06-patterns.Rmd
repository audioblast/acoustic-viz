# Patterns of activity
Lots of organismal activities are tied to the cycles of the day, and particularly in temperate zones, cycles of the year. These cycles bring regular fluctuations in light levels, day lengths, temperatures, and a host of other influences. Often these cycles interact, with the dawn chorus peaking in the early daylight hours, and it's timing and intensity fluctuating on a yearly cycle. This chapter looks at visualising these cycles, and additionally the effects of lunar cycles.

These plots are created using the SonicScrewdriver package [@sonicscrewdriver] which in turn uses the suncalc package [@suncalc] to perform the required sun and moon position calculations. The Plotrix package [@plotrix] is used for creating the visualisation. These packages can be installed as shown below.

```{r eval=FALSE}
install.packages(c("plotrix", "sonicscrewdriver"))
```

The SonicScrewdriver package must be loaded before constructing a visual.

```{r message=FALSE}
library(sonicscrewdriver)
```

## Daily Cycles { #daily-cycles }
The use of the term _diel_ for daily cycles has been contested by @broughton1963 as being an incorrectly formed unnecessary neologism, it sees greater use (according to the online Oxford English Dictionary) than his suggested _nycthemeral_.

The design for these plots came from a desire to compare the dawn chorus at various locations around the UK, although they also offer great potential for comparing locations with greater longitudinal and/or latitudinal separation. The plots show the times of day, night, twilight (\@ref(twilight-types)), sunrise, sunset, nadir and solar noon. The day part of the plot shows the altitude (angle of the sun above the horizon) throughout the day, with the maximum value representing the sun being directly overhead.

### The Types of Twilight { #twilight-types }

```{r, twilights, fig.asp=0.6875, fig.width=9, fig.cap='Different types of twilight as the sun sets below the horizon', fig.align='center', out.width='90%', echo=FALSE}
plot.default(
  NULL, 
  NULL, 
  xlim=c(-0.2,1.4),
  ylim=c(-1,0.1),
  axes=FALSE,
  xlab="",
  ylab=""
)

# Horizon
lines(c(0,1), c(0,0))

text(0,0,"horizon",cex=0.8,adj=c(1,0))

degs <- c(18,12,6)
rads <- degs*2*pi/360
labs <- c("astronomical", "nautical", "civil")
fills <- c(rgb(0.4,0.4,0.4,1), rgb(0.6,0.6,0.6,1), rgb(0.8,0.8,0.8,1))
labs <- paste0("-",degs,"°: ",labs)

sunset_y <- -tan(rads)

for (i in 1:length(sunset_y)) {
  x <- c(0,1,1)
  y <- c(0,0,sunset_y[i])
  polygon(x,y, col=fills[i])
  text(1.01,sunset_y[i], labs[i], adj=c(0,0), cex=0.8)
}
```

#### Civil Twilight
Civil twilight occurs when the geometric centre of the sun (as seen from Earth) passes between 0° and 6° below the horizon. During this time it is normal for humans not to need the assistance of artifical light for everyday tasks.

#### Nautical Twilight
Nautical twilight occurs when the sun is between 6° and 12° below the horizon. During this time there is sufficient light to distinguish the horizon even without illumination from the moon (allowing determination of position at sea through star sightings).

#### Astronomical Twilight
When the sun is between 12° and 18° below the horizon many astronomical observations are possible even though some light from the sun is visible through the atmosphere. In urban areas with light pollution this is often considered to be a dark sky.

### Diel Plots {#diel-plots }
As the times of the solar day are dependent both on the date and location these must be passed to the `dielPlot()` function.


```{r diel-plot-1, fig.height=7, fig.width=9, fig.cap='Example of a diel plot', fig.align='center', out.width='90%'}
dielPlot("2022-08-08", lat=53, lon=0.1)
```

#### Customising a `dielPlot()`

In addition to the `date`, `lat` and `lon` parameters to `dielPlot()` it is possible to make additional customisations to how the information is presented.

__Legend__

A legend can be added to the plot by setting `legend=TRUE`.

```{r diel-plot-legend, fig.height=7, fig.width=9, fig.cap='Example adding a legend to a diel plot', fig.align='center', out.width='90%'}
dielPlot("2022-08-08", lat=53, lon=0.1, legend=TRUE)
```


__Plotting Components__

The components that can be plotted are listed below. By default all are plotted except for `Solar Noon` and `Nadir`. 

Name |Notes
-----|------
Astronomical Twilight |
Nautical Twilight |
Civil Twilight |
Sunrise |
Solar Noon | The time when the sun is highest in the sky
Sunset |
Nadir |

The components that are plotted can be specified using the `plot` parameter.

```{r diel-plot-components, fig.height=7, fig.width=9, fig.cap='Example adding a legend to a diel plot', fig.align='center', out.width='90%'}
components <- c("Sunrise", "Sunset", "Solar Noon", "Nadir")
dielPlot("2022-08-08", lat=53, lon=0.1, plot=components)
```

## Yearly Cycles

The `yearlyPlot()` function from the SonicScrewdriver package shows daylight changes throughout a year. It behaves in a very similar fashion to `dielPlot` but takes a single year rather a date as input.

```{r yearly-plot-1, fig.height=7, fig.width=9, fig.cap='Example of a yearly plot', fig.align='center', out.width='90%'}
yearlyPlot(2022, lat=53, lon=0.1)
```

## Lunar Cycles

## Core and ring plots

These visualisations for cyclical data plot their information onto a circle with radius of two units. It is possible to limit the plot either to the centre of the circle (a 'core' plot) or to the edge (a 'ring plot'). These alternative forms may be more useful when these plots are used to visualise addition variables (\@ref(adding-to-cyclical)).

```{r diel-plot-core, fig.height=7, fig.width=9, fig.cap='A \'core\' diel plot.', fig.align='center', out.width='90%'}
dielPlot("2022-08-08", lat=53, lon=0.1, limits=c(0,1))
```

```{r diel-plot-ring, fig.height=7, fig.width=9, fig.cap='A \'ring\' diel plot.', fig.align='center', out.width='90%', cache=TRUE}
dielPlot("2022-08-08", lat=53, lon=0.1, limits=c(1,2))
```

## Adding data to the visualisation { #adding-to-cyclical }

### Rings

The ring functions (`dielRing()`,...) plot ring segments on top of a base cyclical plot. These rings are useful for showing typical periods of activity for a species, or events that happen continuously for a specified period of time.

By defaults the limits for the rings are `1,2` for use with a _core_ type plot, but this can be changed by specifying the `limits` parameter to the ring function. Similarly, the plot legend may be removed with the paramater `legend=FALSE`.

#### `dielRings()`

```{r diel-plot-rings-1, fig.height=7, fig.width=10, fig.cap='A \'core\' diel plot with diel rings.', fig.align='center', out.width='90%'}
names <- c("activity 1", "activity 2", "activity 3")
starts <- c("0600", "0900", "1500")
ends <- c("1200", "1700", "1900")
cols <- c("red", "green", "blue")

dielPlot("2022-08-08", lat=53, lon=0.1, limits=c(0,1))
dielRings(names, starts, ends, cols=cols)
```

```{r diel-plot-rings-2, fig.height=7, fig.width=10, fig.cap='A \'ring\' diel plot with diel rings.', fig.align='center', out.width='90%', cache=TRUE}
names <- c("activity 1", "activity 2", "activity 3")
starts <- c("0600", "0900", "1500")
ends <- c("1200", "1700", "1900")
cols <- c("red", "green", "blue")

dielPlot("2022-08-08", lat=53, lon=0.1, limits=c(1,2))
dielRings(names, starts, ends, cols=cols, limits=c(0,1))
```

## Behind the scenes

The majority of the plotting performed for cyclical plots in `SonicScrewdriver` is performed by the `radialPolygon()` function. This function can be used to plot sectors, annuli, horizon plots and irregular polygons. If you wish to customise cyclical plots beyond what the helper functions such as `dielRings()` allow then it is likely that `radialPolygon()` is the tool you need.

```{r radialPolygon-types, fig.height=7, fig.width=9, fig.cap='Types of radial polygon plot', fig.align='center', out.width='90%'}
plotrix::radial.plot(
  lengths=0,
  radial.pos=0,
  rp.type="p",
  radial.lim=c(0,1,2),
  start=pi,
  label.pos = dielLabels(pos='pos')*pi/180,
  labels=dielLabels(),
  clockwise=T,
  poly.col=rgb(1,1,0, 0.6),
  lty=0,
  show.grid.labels = F)

radialPolygon(pi/6,pi/3, 0, 2,col="red")
radialPolygon(pi/2,pi,1.75,2, col="blue")

wave <- c(0,0.25,0.5,0.25,0,0.25,0.5,0.25)
angs <- pi + 1:8 * pi/16
radialPolygon(NA,angs,1,1.25+wave, col="orange")
angs <- angs+ pi/2
radialPolygon(angs,angs,1+rev(wave), 1.25+wave, col="green")

legend(
  -3,2.5,
  c("sector", "annulus", "horizon", "polygon"),
  col=c("red", "blue", "orange", "green"),
  lty=1,
  lwd=5,
  bty = "n",
  cex = 1)
```

## Interactive Plots
These plots can be used to create Shiny apps

* [shiny-diel](https://shiny.ebaker.me.uk/shiny-diel/) is an example that shows diel plots for a number of locations, and can be animated using the play button under the date slider.
